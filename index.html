<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduNature Explorer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2a9d8f;
            --primary-dark: #21867a;
            --secondary: #e9c46a;
            --success: #4cc9f0;
            --danger: #e76f51;
            --warning: #f4a261;
            --light: #f8f9fa;
            --dark: #264653;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --border-radius: 12px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #264653 0%, #2a9d8f 100%);
            color: var(--light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Nature Site */
        .nature-site {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow-y: auto;
            padding: 20px;
            animation: fadeIn 1s ease;
        }

        .nature-header {
            text-align: center;
            padding: 40px 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            margin-bottom: 40px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nature-header h1 {
            font-size: 3.5rem;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 15px;
            font-weight: 800;
        }

        .nature-header p {
            font-size: 1.3rem;
            color: var(--light);
            max-width: 800px;
            margin: 0 auto 30px;
            line-height: 1.6;
        }

        .nature-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            padding: 20px;
            margin-bottom: 60px;
        }

        .nature-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
        }

        .nature-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.12);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .nature-card h2 {
            color: var(--secondary);
            margin-bottom: 15px;
            font-size: 1.8rem;
        }

        .nature-card p {
            line-height: 1.6;
            margin-bottom: 15px;
            color: rgba(255, 255, 255, 0.9);
        }

        .fact-box {
            background: rgba(233, 196, 106, 0.1);
            border-left: 4px solid var(--secondary);
            padding: 15px;
            margin-top: 15px;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }

        /* Password Modal */
        .password-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .password-box {
            background: rgba(38, 70, 83, 0.95);
            padding: 40px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            text-align: center;
            border: 2px solid var(--primary);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .password-box h2 {
            color: var(--secondary);
            margin-bottom: 20px;
            font-size: 2rem;
        }

        .password-box p {
            color: var(--light);
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .password-input {
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--primary);
            border-radius: var(--border-radius);
            color: var(--light);
            font-size: 1.1rem;
            margin-bottom: 20px;
            text-align: center;
            letter-spacing: 2px;
            font-weight: bold;
        }

        .password-input:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(233, 196, 106, 0.3);
        }

        /* Login Screen */
        .login-screen {
            display: none;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-container {
            background: rgba(38, 70, 83, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            padding: 40px;
            width: 100%;
            max-width: 450px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.6s ease-out;
        }

        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .login-header h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 15px;
            font-weight: 800;
        }

        .login-header p {
            color: var(--gray);
            font-size: 1.1rem;
        }

        .login-icon {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 80px;
            height: 80px;
            margin: 0 auto 25px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 20px;
            font-size: 2.5rem;
            color: white;
            box-shadow: 0 8px 32px rgba(42, 157, 143, 0.4);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--light);
            font-weight: 600;
            font-size: 0.95rem;
        }

        .form-control {
            width: 100%;
            padding: 14px 20px;
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            color: var(--light);
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(42, 157, 143, 0.2);
            background: rgba(255, 255, 255, 0.1);
        }

        .form-control.username-locked {
            background: rgba(76, 201, 240, 0.1);
            border-color: var(--success);
            color: var(--success);
            cursor: not-allowed;
        }

        .form-hint {
            display: block;
            margin-top: 8px;
            font-size: 0.85rem;
            min-height: 22px;
        }

        .form-hint.success {
            color: var(--success);
        }

        .form-hint.error {
            color: var(--danger);
        }

        .form-hint.info {
            color: var(--gray);
        }

        .btn-block {
            width: 100%;
            justify-content: center;
            padding: 15px;
            font-size: 1.1rem;
            margin-top: 10px;
        }

        .login-footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            color: var(--gray);
            font-size: 0.9rem;
        }

        /* Main App Styles */
        .container {
            display: none;
            flex: 1;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            width: 280px;
            background: rgba(38, 70, 83, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            overflow: hidden;
        }

        .logo {
            display: flex;
            align-items: center;
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--success);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px rgba(76, 201, 240, 0.3);
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-left: 12px;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background: rgba(38, 70, 83, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .search-bar {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            padding: 8px 15px;
            width: 400px;
        }

        .search-bar input {
            background: transparent;
            border: none;
            color: var(--light);
            width: 100%;
            padding: 5px 10px;
            outline: none;
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 30px;
            padding: 8px 20px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 30px;
            transition: var(--transition);
        }

        .user-profile:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .content-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .chat-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255, 255, 255, 0.05);
            height: 70vh;
        }

        .chat-header {
            padding: 15px 20px;
            background: rgba(38, 70, 83, 0.9);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
        }

        .message {
            display: flex;
            max-width: 75%;
            position: relative;
            animation: fadeIn 0.3s ease;
        }

        .message.sent {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.received {
            align-self: flex-start;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            margin: 0 10px;
            flex-shrink: 0;
            cursor: pointer;
        }

        .message-content-wrapper {
            display: flex;
            flex-direction: column;
            max-width: calc(100% - 56px);
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .message.sent .message-bubble {
            background: var(--primary);
            border-bottom-right-radius: 5px;
            box-shadow: 0 2px 8px rgba(42, 157, 143, 0.3);
        }

        .message.received .message-bubble {
            background: rgba(255, 255, 255, 0.1);
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .message-content {
            margin-bottom: 5px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: normal;
            overflow-wrap: break-word;
        }

        .message-sender {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .message-sender:hover {
            text-decoration: underline;
        }

        .message-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.7rem;
            opacity: 0.8;
            margin-top: 5px;
        }

        .chat-input {
            padding: 15px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 12px 15px;
            border-radius: 30px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--light);
            outline: none;
            transition: var(--transition);
        }

        .chat-input input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(42, 157, 143, 0.2);
        }

        /* Typing Indicator */
        .typing-indicator {
            padding: 10px 20px;
            color: var(--gray);
            font-size: 0.8rem;
            font-style: italic;
            height: 20px;
            transition: opacity 0.3s ease;
        }

        .typing-indicator:empty {
            opacity: 0;
        }

        /* Alert System */
        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: var(--border-radius);
            color: white;
            z-index: 1100;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            animation: slideInRight 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 350px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert.success {
            background: rgba(76, 201, 240, 0.15);
            border-left: 4px solid var(--success);
        }

        .alert.error {
            background: rgba(231, 111, 81, 0.15);
            border-left: 4px solid var(--danger);
        }

        .alert.warning {
            background: rgba(244, 162, 97, 0.15);
            border-left: 4px solid var(--warning);
        }

        .alert.info {
            background: rgba(42, 157, 143, 0.15);
            border-left: 4px solid var(--primary);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Date Separator */
        .date-separator {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 20px 0;
            color: var(--gray);
            font-size: 0.9rem;
        }

        .date-separator::before,
        .date-separator::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .date-separator span {
            padding: 0 15px;
        }

        /* Video Call Container */
        #videoCallContainer {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 320px;
            height: 240px;
            background: rgba(0, 0, 0, 0.95);
            border-radius: var(--border-radius);
            display: none;
            flex-direction: column;
            z-index: 1000;
            border: 2px solid var(--primary);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        #videoCallContainer.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            border-radius: 0;
            z-index: 2000;
        }

        .call-videos {
            flex: 1;
            display: flex;
            gap: 5px;
            padding: 10px;
            transition: all 0.3s ease;
        }

        .call-videos.single-view {
            gap: 0;
            padding: 0;
        }

        .video-wrapper {
            flex: 1;
            border-radius: 8px;
            overflow: hidden;
            background: #000;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 100px;
        }

        .video-wrapper:hover {
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(42, 157, 143, 0.3);
        }

        .video-wrapper.focused {
            flex: 3 !important;
            z-index: 2;
        }

        .video-wrapper.minimized {
            flex: 0.5;
            opacity: 0.7;
        }

        .call-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: rotateY(180deg); /* Mirror effect for self-view */
        }

        .video-label {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 10;
        }

        .call-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
        }

        .call-controls button {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            font-size: 12px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        #callMuteBtn {
            background: #f39c12;
            color: white;
        }

        #callFullscreenBtn {
            background: #3498db;
            color: white;
        }

        #callShareBtn {
            background: #2ecc71;
            color: white;
        }

        #callHangupBtn {
            background: #c0392b;
            color: white;
        }

        #callHangupBtn:hover {
            background: #a93226;
        }

        /* Users list styling */
        .users-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .user-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            transition: var(--transition);
            cursor: pointer;
        }

        .user-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .user-item.active {
            background: rgba(42, 157, 143, 0.15);
            border-left: 3px solid var(--primary);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            margin-right: 12px;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .user-status {
            font-size: 0.8rem;
            display: flex;
            align-items: center;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .status-dot.online {
            background: var(--success);
        }

        .status-dot.offline {
            background: var(--gray);
        }

        /* Private Chat Modal */
        .private-chat-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2500;
        }

        .private-chat-box {
            background: rgba(38, 70, 83, 0.97);
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 600px;
            height: 80vh;
            display: flex;
            flex-direction: column;
            border: 2px solid var(--primary);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        .private-chat-header {
            padding: 20px;
            background: rgba(38, 70, 83, 0.9);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .private-chat-header h3 {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-size: 1.4rem;
        }

        .private-chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .private-chat-input {
            padding: 15px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 10px;
        }

        .private-chat-input input {
            flex: 1;
            padding: 12px 15px;
            border-radius: 30px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--light);
            outline: none;
        }

        /* Scrollbar styling */
        .chat-messages::-webkit-scrollbar,
        .private-chat-messages::-webkit-scrollbar,
        .users-container::-webkit-scrollbar,
        .nature-site::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track,
        .private-chat-messages::-webkit-scrollbar-track,
        .users-container::-webkit-scrollbar-track,
        .nature-site::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb,
        .private-chat-messages::-webkit-scrollbar-thumb,
        .users-container::-webkit-scrollbar-thumb,
        .nature-site::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }

        /* Cooldown timer */
        .cooldown-timer {
            font-size: 0.7rem;
            opacity: 0.8;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <!-- Nature Site -->
    <div class="nature-site" id="nature-site">
        <div class="nature-header">
            <h1>üåø EduNature Explorer</h1>
            <p>Discover the wonders of our planet's ecosystems and learn about the delicate balance of nature that sustains all life.</p>
        </div>
        
        <div class="nature-content">
            <div class="nature-card">
                <h2>üå≥ Rainforest Ecosystem</h2>
                <p>Rainforests are Earth's oldest living ecosystems, covering only 6% of the planet's surface but containing over half of the world's plant and animal species.</p>
                <div class="fact-box">
                    <strong>Did you know?</strong> A single hectare of rainforest can contain up to 750 types of trees and 1,500 species of higher plants.
                </div>
            </div>
            
            <div class="nature-card">
                <h2>üêã Ocean Biodiversity</h2>
                <p>The oceans hold about 97% of Earth's water and are home to an incredible diversity of life, from microscopic plankton to the largest animal ever known - the blue whale.</p>
                <div class="fact-box">
                    <strong>Did you know?</strong> Scientists estimate that over 90% of ocean species remain undiscovered and unnamed.
                </div>
            </div>
            
            <div class="nature-card">
                <h2>üèîÔ∏è Mountain Habitats</h2>
                <p>Mountains cover approximately 24% of Earth's land surface and provide habitats for unique species adapted to high altitudes and extreme conditions.</p>
                <div class="fact-box">
                    <strong>Did you know?</strong> Mountains are called "water towers" because they provide 60-80% of the world's freshwater.
                </div>
            </div>
            
            <div class="nature-card">
                <h2>üåµ Desert Adaptations</h2>
                <p>Deserts may seem barren, but they host specially adapted plants and animals that have evolved remarkable strategies to survive extreme heat and water scarcity.</p>
                <div class="fact-box">
                    <strong>Did you know?</strong> The Sahara Desert wasn't always dry - 11,000 years ago it was covered in grasslands and lakes.
                </div>
            </div>
            
            <div class="nature-card">
                <h2>ü¶ã Pollinator Importance</h2>
                <p>Pollinators like bees, butterflies, and birds are essential for the reproduction of over 85% of the world's flowering plants, including many food crops.</p>
                <div class="fact-box">
                    <strong>Did you know?</strong> One out of every three bites of food we eat exists because of pollinators.
                </div>
            </div>
            
            <div class="nature-card">
                <h2>üåä Coral Reef Systems</h2>
                <p>Coral reefs are often called "the rainforests of the sea" due to their incredible biodiversity, supporting approximately 25% of all marine species.</p>
                <div class="fact-box">
                    <strong>Did you know?</strong> The Great Barrier Reef is the largest living structure on Earth, visible from space.
                </div>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div class="password-modal" id="password-modal">
        <div class="password-box">
            <div class="login-icon">
                <i class="fas fa-lock"></i>
            </div>
            <h2>Educational Portal Access</h2>
            <p>Enter the educational access code to continue to the collaborative learning platform.</p>
            <input type="password" class="password-input" id="password-input" placeholder="Enter access code" autocomplete="off">
            <button class="btn btn-block" id="password-submit">
                <i class="fas fa-unlock"></i>
                Access Platform
            </button>
        </div>
    </div>

    <!-- Login Screen -->
    <div class="login-screen" id="login-screen">
        <div class="login-container">
            <div class="login-header">
                <div class="login-icon">
                    <i class="fas fa-comments"></i>
                </div>
                <h1>EduNature Chat</h1>
                <p>Collaborative learning platform</p>
            </div>
            
            <form id="login-form">
                <div class="form-group">
                    <label for="username-input" class="form-label">Choose Your Username</label>
                    <input type="text" id="username-input" class="form-control" 
                           placeholder="Enter your username..." 
                           autocomplete="off"
                           maxlength="20">
                    <div id="username-status" class="form-hint"></div>
                </div>
                
                <div class="form-group">
                    <button type="button" class="btn btn-block" id="login-btn">
                        <i class="fas fa-sign-in-alt"></i>
                        Enter Chat Room
                    </button>
                </div>
            </form>
            
            <div class="login-footer">
                <p>No registration required ‚Ä¢ Start chatting instantly</p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div class="container" id="main-app" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <div class="logo-icon">E</div>
                <h1>EduNature</h1>
            </div>
            
            <div>
                <div style="font-size: 0.8rem; text-transform: uppercase; color: var(--gray); padding: 0 20px; margin-bottom: 10px; letter-spacing: 1px;">Online Users</div>
                <div class="users-container" id="users-container">
                    <div style="text-align: center; padding: 40px 20px; color: var(--gray);">
                        <i class="fas fa-user-friends" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>No users online</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search messages..." id="search-messages">
                </div>
                
                <div class="user-actions">
                    <div class="user-profile" id="account-btn">
                        <div class="avatar" id="user-avatar">?</div>
                        <div>
                            <div id="account-btn-text">User</div>
                            <div style="font-size: 0.8rem; color: var(--success); font-weight: 500;">Online</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="content-area">
                <div class="content-header">
                    <h2 style="background: linear-gradient(90deg, var(--primary), var(--secondary)); -webkit-background-clip: text; background-clip: text; color: transparent;">Global Chat</h2>
                    <button class="btn btn-outline" id="refresh-btn">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                </div>
                
                <div class="chat-container">
                    <div class="chat-header">
                        <h3>Global Chat Room</h3>
                        <div class="user-status">
                            <span class="status-dot online"></span>
                            <span id="online-count">1</span> users online
                        </div>
                    </div>
                    
                    <div class="chat-messages" id="chat-messages">
                        <div style="text-align: center; padding: 40px 20px; color: var(--gray);">
                            <i class="fas fa-comments" style="font-size: 2rem; margin-bottom: 10px;"></i>
                            <p>No messages yet. Start chatting!</p>
                        </div>
                    </div>
                    
                    <!-- Typing Indicator -->
                    <div class="typing-indicator" id="typing-indicator"></div>
                    
                    <div class="chat-input">
                        <input type="text" placeholder="Type a message..." id="message-input">
                        <div style="display: flex; gap: 10px;">
                            <button class="btn" id="send-message" style="padding: 12px 20px;">
                                <i class="fas fa-paper-plane"></i>
                                Send
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Call Container -->
    <div id="videoCallContainer">
        <div class="call-videos" id="callVideos">
            <div class="video-wrapper" id="local-video-wrapper">
                <video class="call-video" id="localVideo" autoplay playsinline muted></video>
                <div class="video-label" id="localLabel">You</div>
            </div>
            <div class="video-wrapper" id="remote-video-wrapper">
                <video class="call-video" id="remoteVideo" autoplay playsinline></video>
                <div class="video-label" id="remoteLabel">Waiting...</div>
            </div>
        </div>
        <div class="call-controls">
            <button id="callMuteBtn">
                <i class="fas fa-microphone"></i>
                Mute
            </button>
            <button id="callFullscreenBtn">
                <i class="fas fa-expand"></i>
                Fullscreen
            </button>
            <button id="callShareBtn">
                <i class="fas fa-share-square"></i>
                Share
            </button>
            <button id="callHangupBtn">
                <i class="fas fa-phone-slash"></i>
                Hangup
            </button>
        </div>
    </div>

    <!-- Private Chat Modal -->
    <div class="private-chat-modal" id="private-chat-modal">
        <div class="private-chat-box">
            <div class="private-chat-header">
                <h3 id="private-chat-title">Private Chat</h3>
                <button class="btn btn-outline" id="close-private-chat">
                    <i class="fas fa-times"></i>
                    Close
                </button>
            </div>
            
            <div class="private-chat-messages" id="private-chat-messages">
                <!-- Private messages will appear here -->
            </div>
            
            <div class="private-chat-input">
                <input type="text" placeholder="Type a private message..." id="private-message-input">
                <button class="btn" id="send-private-message" style="padding: 12px 20px;">
                    <i class="fas fa-paper-plane"></i>
                    Send
                </button>
            </div>
        </div>
    </div>

    <!-- SimplePeer Library (Simpler than PeerJS) -->
    <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

        const SUPABASE_URL = "https://dljjeflngwqrvrsfsfsa.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsamplZmxuZ3dxcnZyc2ZzZnNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NjY1MTUsImV4cCI6MjA3NzM0MjUxNX0.yNV1UtLFCLV8J53XO0zpk3M8CKT2BtxjAlZ60v_eytc";
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // DOM Elements
        const natureSite = document.getElementById('nature-site');
        const passwordModal = document.getElementById('password-modal');
        const passwordInput = document.getElementById('password-input');
        const passwordSubmit = document.getElementById('password-submit');
        const loginScreen = document.getElementById('login-screen');
        const mainApp = document.getElementById('main-app');
        const usernameInput = document.getElementById('username-input');
        const loginBtn = document.getElementById('login-btn');
        const usernameStatus = document.getElementById('username-status');
        const userAvatar = document.getElementById('user-avatar');
        const accountBtnText = document.getElementById('account-btn-text');
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-message');
        const usersContainer = document.getElementById('users-container');
        const onlineCount = document.getElementById('online-count');
        const refreshBtn = document.getElementById('refresh-btn');
        const searchMessages = document.getElementById('search-messages');
        const typingIndicator = document.getElementById('typing-indicator');
        
        // Private Chat Elements
        const privateChatModal = document.getElementById('private-chat-modal');
        const privateChatTitle = document.getElementById('private-chat-title');
        const privateChatMessages = document.getElementById('private-chat-messages');
        const privateMessageInput = document.getElementById('private-message-input');
        const sendPrivateBtn = document.getElementById('send-private-message');
        const closePrivateChat = document.getElementById('close-private-chat');

        // Call Elements
        const videoContainer = document.getElementById('videoCallContainer');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const localLabel = document.getElementById('localLabel');
        const remoteLabel = document.getElementById('remoteLabel');
        const callMuteBtn = document.getElementById('callMuteBtn');
        const callFullscreenBtn = document.getElementById('callFullscreenBtn');
        const callShareBtn = document.getElementById('callShareBtn');
        const callHangupBtn = document.getElementById('callHangupBtn');
        const localVideoWrapper = document.getElementById('local-video-wrapper');
        const remoteVideoWrapper = document.getElementById('remote-video-wrapper');
        const callVideos = document.getElementById('callVideos');

        // App State
        let username = '';
        const colorMap = {};
        const localEchoQueue = [];
        const privateLocalEchoQueue = [];
        const chatUsers = new Map();
        let lastMessageDate = null;
        let deviceId = localStorage.getItem('deviceId') || generateDeviceId();
        let onlineCheckInterval = null;
        let lastStatusUpdate = 0;
        let isPasswordUnlocked = localStorage.getItem('passwordUnlocked') === 'true';
        let currentPrivateChatWith = null;
        let privateChatHistory = {};

        // SimplePeer Call State
        let currentCall = null;
        let isInCall = false;
        let localStream = null;
        let peer = null;
        let callChannel = null;
        let isMuted = false;
        let isFullscreen = false;
        let callCooldown = false;
        let currentCallTarget = null;
        let focusedVideo = null;
        let screenStream = null;
        let isScreenSharing = false;

        // Cooldown states
        let messageCooldown = false;
        let privateMessageCooldown = false;
        let messageCooldownTimer = null;
        let privateMessageCooldownTimer = null;

        // ==================== VIDEO FOCUS FUNCTIONALITY ====================
        
        function setupVideoFocus() {
            localVideoWrapper.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent event bubbling
                
                if (focusedVideo === 'local') {
                    // Reset focus
                    localVideoWrapper.classList.remove('focused');
                    remoteVideoWrapper.classList.remove('minimized');
                    focusedVideo = null;
                } else {
                    // Focus on local
                    localVideoWrapper.classList.add('focused');
                    remoteVideoWrapper.classList.add('minimized');
                    focusedVideo = 'local';
                }
                
                // Update the call videos container
                updateVideoLayout();
            });
            
            remoteVideoWrapper.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent event bubbling
                
                if (focusedVideo === 'remote') {
                    // Reset focus
                    remoteVideoWrapper.classList.remove('focused');
                    localVideoWrapper.classList.remove('minimized');
                    focusedVideo = null;
                } else {
                    // Focus on remote
                    remoteVideoWrapper.classList.add('focused');
                    localVideoWrapper.classList.add('minimized');
                    focusedVideo = 'remote';
                }
                
                // Update the call videos container
                updateVideoLayout();
            });
        }

        function updateVideoLayout() {
            if (focusedVideo === 'local') {
                localVideoWrapper.style.flex = '3';
                remoteVideoWrapper.style.flex = '0.5';
                localVideoWrapper.style.zIndex = '2';
                remoteVideoWrapper.style.zIndex = '1';
                localVideoWrapper.style.opacity = '1';
                remoteVideoWrapper.style.opacity = '0.7';
            } else if (focusedVideo === 'remote') {
                localVideoWrapper.style.flex = '0.5';
                remoteVideoWrapper.style.flex = '3';
                localVideoWrapper.style.zIndex = '1';
                remoteVideoWrapper.style.zIndex = '2';
                localVideoWrapper.style.opacity = '0.7';
                remoteVideoWrapper.style.opacity = '1';
            } else {
                localVideoWrapper.style.flex = '1';
                remoteVideoWrapper.style.flex = '1';
                localVideoWrapper.style.zIndex = '1';
                remoteVideoWrapper.style.zIndex = '1';
                localVideoWrapper.style.opacity = '1';
                remoteVideoWrapper.style.opacity = '1';
            }
        }

        // ==================== SIMPLEPEER CALL SYSTEM ====================
        
        function initializeCallSystem() {
            console.log('üìû Call system initialized');
        }

        async function getMediaStream(videoConstraints = {}) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: "user",
                        ...videoConstraints
                    },
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });
                return stream;
            } catch (error) {
                console.error('Error accessing media:', error);
                showAlert("Media Error", "Please allow camera and microphone access", "error");
                throw error;
            }
        }

        async function getScreenStream() {
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: {
                        cursor: "always",
                        displaySurface: "monitor"
                    },
                    audio: true
                });
                
                // Handle when user stops sharing screen
                stream.getVideoTracks()[0].onended = () => {
                    if (isScreenSharing) {
                        stopScreenShare();
                    }
                };
                
                return stream;
            } catch (error) {
                console.error('Error accessing screen:', error);
                showAlert("Screen Share Error", "Could not share screen", "error");
                throw error;
            }
        }

        async function startScreenShare() {
            if (isScreenSharing || !peer || !isInCall) {
                return;
            }
            
            try {
                screenStream = await getScreenStream();
                isScreenSharing = true;
                
                // Replace the video track in the peer connection
                const screenTrack = screenStream.getVideoTracks()[0];
                const sender = peer._senders.find(s => s.track && s.track.kind === 'video');
                
                if (sender) {
                    sender.replaceTrack(screenTrack);
                }
                
                // Update local video to show screen share
                localVideo.srcObject = screenStream;
                localLabel.textContent = `${username} (Sharing Screen)`;
                
                // Update share button
                callShareBtn.innerHTML = '<i class="fas fa-stop"></i> Stop Sharing';
                callShareBtn.style.background = '#e74c3c';
                
                showAlert("Screen Sharing", "Your screen is now being shared", "success");
                
            } catch (error) {
                console.error('Screen share failed:', error);
                isScreenSharing = false;
            }
        }

        async function stopScreenShare() {
            if (!isScreenSharing) return;
            
            try {
                // Stop screen stream
                if (screenStream) {
                    screenStream.getTracks().forEach(track => track.stop());
                    screenStream = null;
                }
                
                // Switch back to camera
                if (localStream) {
                    const cameraTrack = localStream.getVideoTracks()[0];
                    const sender = peer._senders.find(s => s.track && s.track.kind === 'video');
                    
                    if (sender && cameraTrack) {
                        sender.replaceTrack(cameraTrack);
                    }
                    
                    // Update local video to show camera
                    localVideo.srcObject = localStream;
                    localLabel.textContent = `${username} (You)`;
                }
                
                isScreenSharing = false;
                
                // Update share button
                callShareBtn.innerHTML = '<i class="fas fa-share-square"></i> Share';
                callShareBtn.style.background = '#2ecc71';
                
                showAlert("Screen Sharing", "Screen sharing stopped", "info");
                
            } catch (error) {
                console.error('Error stopping screen share:', error);
            }
        }

        async function toggleShareScreen() {
            if (isScreenSharing) {
                await stopScreenShare();
            } else {
                await startScreenShare();
            }
        }

        // Modified initiateCall function
        window.initiateCall = async function(targetUser) {
            if (callCooldown || isInCall) {
                return;
            }
            
            const userData = chatUsers.get(targetUser);
            if (!userData || !userData.online || targetUser === username) {
                showAlert("Cannot Call", "User is offline or unavailable", "warning");
                return;
            }
            
            try {
                console.log(`üìû Calling ${targetUser}...`);
                currentCallTarget = targetUser;
                
                // Get media stream
                const stream = await getMediaStream();
                localStream = stream;
                localVideo.srcObject = stream;
                localLabel.textContent = `${username} (You)`;
                
                // Create peer as initiator
                peer = new SimplePeer({
                    initiator: true,
                    trickle: false,
                    stream: stream,
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' }
                        ]
                    }
                });
                
                // Set up peer event handlers
                peer.on('signal', (data) => {
                    console.log('üì° Sending signal data');
                    // Send signal data to target user via Supabase
                    if (callChannel) {
                        callChannel.send({
                            type: 'broadcast',
                            event: 'call-signal',
                            payload: {
                                to: targetUser,
                                from: username,
                                signal: data,
                                type: 'offer'
                            }
                        });
                    }
                });
                
                peer.on('stream', (remoteStream) => {
                    console.log('‚úÖ Received remote stream');
                    remoteVideo.srcObject = remoteStream;
                    remoteLabel.textContent = targetUser;
                    videoContainer.style.display = 'flex';
                    isInCall = true;
                    currentCall = peer;
                    
                    // Setup video focus after call is connected
                    setupVideoFocus();
                    
                    showAlert("Call Connected", `Connected to ${targetUser}`, "success", 2000);
                });
                
                peer.on('close', () => {
                    console.log('üìû Call closed');
                    endVideoCall();
                });
                
                peer.on('error', (err) => {
                    console.error('Peer error:', err);
                    showAlert("Call Error", "Connection failed", "error");
                    endVideoCall();
                });
                
                // Show call UI
                videoContainer.style.display = 'flex';
                remoteLabel.textContent = `Calling ${targetUser}...`;
                
                // Setup video focus for initial state
                setupVideoFocus();
                
                // Set cooldown
                callCooldown = true;
                setTimeout(() => {
                    callCooldown = false;
                }, 3000);
                
            } catch (error) {
                console.error('Call failed:', error);
                showAlert("Call Failed", "Could not start call", "error");
                
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }
                
                callCooldown = false;
            }
        };

        function setupCallChannel() {
            callChannel = supabase.channel("webrtc-calls");
            
            callChannel.subscribe();
            
            // Handle incoming call signals
            callChannel.on("broadcast", { event: "call-signal" }, async (payload) => {
                const { to, from, signal, type } = payload.payload;
                
                if (to !== username) return;
                
                console.log(`üìû Received signal from ${from}, type: ${type}`);
                
                if (type === 'offer') {
                    // Incoming call
                    if (isInCall) {
                        // Busy, send busy signal
                        if (callChannel) {
                            callChannel.send({
                                type: 'broadcast',
                                event: 'call-signal',
                                payload: {
                                    to: from,
                                    from: username,
                                    signal: null,
                                    type: 'busy'
                                }
                            });
                        }
                        return;
                    }
                    
                    currentCallTarget = from;
                    
                    try {
                        // Get media stream
                        const stream = await getMediaStream();
                        localStream = stream;
                        localVideo.srcObject = stream;
                        localLabel.textContent = `${username} (You)`;
                        
                        // Create peer as answerer
                        peer = new SimplePeer({
                            initiator: false,
                            trickle: false,
                            stream: stream,
                            config: {
                                iceServers: [
                                    { urls: 'stun:stun.l.google.com:19302' },
                                    { urls: 'stun:stun1.l.google.com:19302' }
                                ]
                            }
                        });
                        
                        // Set up peer event handlers
                        peer.on('signal', (data) => {
                            console.log('üì° Sending answer signal');
                            // Send answer signal back
                            if (callChannel) {
                                callChannel.send({
                                    type: 'broadcast',
                                    event: 'call-signal',
                                    payload: {
                                        to: from,
                                        from: username,
                                        signal: data,
                                        type: 'answer'
                                    }
                                });
                            }
                        });
                        
                        peer.on('stream', (remoteStream) => {
                            console.log('‚úÖ Received remote stream from', from);
                            remoteVideo.srcObject = remoteStream;
                            remoteLabel.textContent = from;
                            videoContainer.style.display = 'flex';
                            isInCall = true;
                            currentCall = peer;
                            
                            // Setup video focus after call is connected
                            setupVideoFocus();
                            
                            showAlert("Call Connected", `Connected to ${from}`, "success", 2000);
                        });
                        
                        peer.on('close', () => {
                            console.log('üìû Call closed');
                            endVideoCall();
                        });
                        
                        peer.on('error', (err) => {
                            console.error('Peer error:', err);
                            endVideoCall();
                        });
                        
                        // Show call UI
                        videoContainer.style.display = 'flex';
                        remoteLabel.textContent = from;
                        
                        // Setup video focus for initial state
                        setupVideoFocus();
                        
                        // Handle the offer signal
                        peer.signal(signal);
                        
                    } catch (error) {
                        console.error('Error answering call:', error);
                        showAlert("Call Failed", "Could not answer call", "error");
                    }
                }
                else if (type === 'answer') {
                    // Answer to our call
                    if (peer && !isInCall && currentCallTarget === from) {
                        console.log('‚úÖ Received answer from', from);
                        peer.signal(signal);
                    }
                }
                else if (type === 'busy') {
                    // Other user is busy
                    if (currentCallTarget === from) {
                        showAlert("User Busy", `${from} is busy on another call`, "warning");
                        endVideoCall();
                    }
                }
            });
            
            // Handle online status
            callChannel.on("broadcast", { event: "online-status" }, (payload) => {
                const { username: user, status, lastSeen, timestamp } = payload.payload;
                
                if (user !== username) {
                    const now = Date.now();
                    chatUsers.set(user, { 
                        lastSeen, 
                        online: status === 'online',
                        lastUpdated: timestamp || now
                    });
                    updateUserList();
                }
            });
            
            // Handle private messages
            callChannel.on("broadcast", { event: "private-message" }, (payload) => {
                const { from, to, message, timestamp, messageId } = payload.payload;
                
                if (to !== username) return;
                
                const chatKey = [from, to].sort().join('_');
                if (privateChatHistory[chatKey]) {
                    const isDuplicate = privateChatHistory[chatKey].some(msg => 
                        msg.message === message && 
                        msg.from === from && 
                        Math.abs(new Date(msg.timestamp) - new Date(timestamp)) < 1000
                    );
                    if (isDuplicate) return;
                }
                
                if (from === currentPrivateChatWith) {
                    addPrivateMessageToChat(from, message, timestamp, false);
                }
                
                if (!privateChatHistory[chatKey]) {
                    privateChatHistory[chatKey] = [];
                }
                privateChatHistory[chatKey].push({
                    from,
                    message,
                    timestamp,
                    isSent: false,
                    messageId: messageId || Date.now()
                });
                
                savePrivateMessages();
                
                if (from !== username && currentPrivateChatWith !== from) {
                    showAlert("Private Message", `${from}: ${message.substring(0, 50)}${message.length > 50 ? '...' : ''}`, "info");
                }
            });
            
            // Handle typing indicator
            callChannel.on("broadcast", { event: "user-typing" }, (payload) => {
                const { username: user, isTyping } = payload.payload;
                
                if (user !== username) {
                    if (isTyping) {
                        typingIndicator.textContent = `${user} is typing...`;
                    } else {
                        typingIndicator.textContent = '';
                    }
                }
            });
        }

        function endVideoCall() {
            console.log('üìû Ending call');
            
            if (peer) {
                peer.destroy();
                peer = null;
            }
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
                localVideo.srcObject = null;
            }
            
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }
            
            if (remoteVideo.srcObject) {
                remoteVideo.srcObject.getTracks().forEach(track => track.stop());
                remoteVideo.srcObject = null;
            }
            
            videoContainer.style.display = 'none';
            isInCall = false;
            currentCall = null;
            currentCallTarget = null;
            isMuted = false;
            isScreenSharing = false;
            
            // Reset video focus
            localVideoWrapper.classList.remove('focused', 'minimized');
            remoteVideoWrapper.classList.remove('focused', 'minimized');
            focusedVideo = null;
            updateVideoLayout();
            
            // Reset mute button
            callMuteBtn.innerHTML = '<i class="fas fa-microphone"></i> Mute';
            callMuteBtn.style.background = '#f39c12';
            
            // Reset share button
            callShareBtn.innerHTML = '<i class="fas fa-share-square"></i> Share';
            callShareBtn.style.background = '#2ecc71';
            
            // Reset labels
            remoteLabel.textContent = 'Waiting...';
            
            // Set cooldown
            callCooldown = true;
            setTimeout(() => {
                callCooldown = false;
            }, 3000);
        }

        function toggleMute() {
            if (!localStream) return;
            
            const audioTracks = localStream.getAudioTracks();
            if (audioTracks.length > 0) {
                isMuted = !isMuted;
                audioTracks[0].enabled = !isMuted;
                
                if (isMuted) {
                    callMuteBtn.innerHTML = '<i class="fas fa-microphone-slash"></i> Unmute';
                    callMuteBtn.style.background = '#e74c3c';
                } else {
                    callMuteBtn.innerHTML = '<i class="fas fa-microphone"></i> Mute';
                    callMuteBtn.style.background = '#f39c12';
                }
            }
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                videoContainer.requestFullscreen();
                videoContainer.classList.add('fullscreen');
                isFullscreen = true;
                callFullscreenBtn.innerHTML = '<i class="fas fa-compress"></i> Exit Fullscreen';
                callFullscreenBtn.style.background = '#e74c3c';
            } else {
                document.exitFullscreen();
                videoContainer.classList.remove('fullscreen');
                isFullscreen = false;
                callFullscreenBtn.innerHTML = '<i class="fas fa-expand"></i> Fullscreen';
                callFullscreenBtn.style.background = '#3498db';
            }
        }

        // ==================== SUPPORTING FUNCTIONS ====================
        
        function generateDeviceId() {
            const id = 'device_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
            localStorage.setItem('deviceId', id);
            return id;
        }

        function showAlert(title, message, type = 'info', duration = 4000) {
            const alert = document.createElement("div");
            alert.className = `alert ${type}`;
            
            let icon = 'fa-info-circle';
            if (type === 'success') icon = 'fa-check-circle';
            else if (type === 'error') icon = 'fa-exclamation-circle';
            else if (type === 'warning') icon = 'fa-exclamation-triangle';
            
            alert.innerHTML = `
                <i class="fas ${icon} alert-icon"></i>
                <div class="alert-content">
                    <div class="alert-title">${title}</div>
                    <div class="alert-message">${message}</div>
                </div>
            `;
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.style.animation = 'slideOutRight 0.4s ease';
                setTimeout(() => {
                    alert.remove();
                }, 400);
            }, duration);
            
            return alert;
        }

        async function isUsernameAvailable(username) {
            const savedUsername = localStorage.getItem('savedUsername');
            const savedDeviceId = localStorage.getItem('savedDeviceId');
            
            if (savedUsername && savedDeviceId === deviceId) {
                return username === savedUsername;
            }
            
            const { data } = await supabase
                .from('themessages')
                .select('username')
                .eq('username', username)
                .order('created_at', { ascending: false })
                .limit(1);
            
            return data.length === 0;
        }

        async function updateOnlineStatus() {
            if (!username) return;
            
            const now = Date.now();
            if (now - lastStatusUpdate < 4000) return;
            
            lastStatusUpdate = now;
            const timestamp = new Date().toISOString();
            
            chatUsers.set(username, { 
                lastSeen: timestamp, 
                online: true,
                lastUpdated: now
            });
            
            if (callChannel) {
                callChannel.send({
                    type: 'broadcast',
                    event: 'online-status',
                    payload: { 
                        username, 
                        status: 'online',
                        lastSeen: timestamp,
                        timestamp: now
                    }
                });
            }
            
            updateUserList();
        }

        function checkOfflineUsers() {
            const now = Date.now();
            chatUsers.forEach((userData, user) => {
                if (user !== username) {
                    const lastUpdated = userData.lastUpdated || 0;
                    const diffSeconds = (now - lastUpdated) / 1000;
                    
                    if (diffSeconds > 10 && userData.online) {
                        userData.online = false;
                        updateUserList();
                    }
                }
            });
        }

        function getUserColor(name) {
            if (!colorMap[name]) {
                let hash = 0;
                for (let i = 0; i < name.length; i++) {
                    hash = name.charCodeAt(i) + ((hash << 5) - hash);
                }
                const hue = hash % 360;
                colorMap[name] = `hsl(${hue}, 70%, 60%)`;
            }
            return colorMap[name];
        }

        function formatMessageDate(date) {
            const now = new Date();
            const messageDate = new Date(date);
            
            if (messageDate.toDateString() === now.toDateString()) {
                return messageDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }
            
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            if (messageDate.toDateString() === yesterday.toDateString()) {
                return 'Yesterday ' + messageDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }
            
            return messageDate.toLocaleDateString([], {month: 'short', day: 'numeric'}) + ' ' + 
                   messageDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function formatTimeSince(timestamp) {
            const now = Date.now();
            const diffSeconds = Math.floor((now - timestamp) / 1000);
            
            if (diffSeconds < 60) {
                return `${diffSeconds}s ago`;
            } else if (diffSeconds < 3600) {
                const minutes = Math.floor(diffSeconds / 60);
                return `${minutes}m ago`;
            } else if (diffSeconds < 86400) {
                const hours = Math.floor(diffSeconds / 3600);
                return `${hours}h ago`;
            } else {
                const days = Math.floor(diffSeconds / 86400);
                return `${days}d ago`;
            }
        }

        function needsDateSeparator(date) {
            if (!lastMessageDate) {
                lastMessageDate = new Date(date).toDateString();
                return true;
            }
            
            const currentDate = new Date(date).toDateString();
            if (currentDate !== lastMessageDate) {
                lastMessageDate = currentDate;
                return true;
            }
            
            return false;
        }

        function createDateSeparator(date) {
            const separator = document.createElement('div');
            separator.className = 'date-separator';
            
            const now = new Date();
            const messageDate = new Date(date);
            
            let dateText;
            if (messageDate.toDateString() === now.toDateString()) {
                dateText = 'Today';
            } else if (messageDate.toDateString() === new Date(now.setDate(now.getDate() - 1)).toDateString()) {
                dateText = 'Yesterday';
            } else {
                dateText = messageDate.toLocaleDateString([], {weekday: 'long', month: 'long', day: 'numeric'});
            }
            
            separator.innerHTML = `<span>${dateText}</span>`;
            return separator;
        }

        function checkAutoLogin() {
            const savedUsername = localStorage.getItem('savedUsername');
            const savedDeviceId = localStorage.getItem('savedDeviceId');
            
            if (savedUsername && savedDeviceId === deviceId) {
                usernameInput.value = savedUsername;
                usernameInput.classList.add('username-locked');
                usernameInput.disabled = true;
                usernameStatus.innerHTML = `<span class="success">‚úì Username locked to this device</span>`;
                
                setTimeout(() => {
                    performLogin(savedUsername);
                }, 500);
            }
        }

        async function performLogin(name) {
            const isAvailable = await isUsernameAvailable(name);
            
            if (!isAvailable && localStorage.getItem('savedUsername') !== name) {
                showAlert("Username Taken", "That username is already taken. Try something more unique!", "error");
                usernameInput.classList.remove('username-locked');
                usernameInput.disabled = false;
                usernameStatus.innerHTML = `<span class="error">‚úó Username taken</span>`;
                return;
            }
            
            username = name;
            
            localStorage.setItem('savedUsername', username);
            localStorage.setItem('savedDeviceId', deviceId);
            
            userAvatar.textContent = username[0].toUpperCase();
            userAvatar.style.background = getUserColor(username);
            accountBtnText.textContent = username;
            
            loginScreen.style.display = 'none';
            mainApp.style.display = 'flex';
            
            const now = Date.now();
            chatUsers.set(username, { 
                lastSeen: new Date().toISOString(), 
                online: true,
                lastUpdated: now
            });
            
            loadMessages();
            loadPrivateMessages();
            setupEventListeners();
            setupCallChannel();
            setupVideoFocus();
            initializeCallSystem();
            
            onlineCheckInterval = setInterval(() => {
                updateOnlineStatus();
                checkOfflineUsers();
            }, 5000);
            
            updateOnlineStatus();
            
            const coolGreetings = [
                "Welcome back, legend!",
                "Hey there, superstar!",
                "Great to see you again!",
                "Ready to connect?",
                "Let's get this party started!"
            ];
            const randomGreeting = coolGreetings[Math.floor(Math.random() * coolGreetings.length)];
            
            showAlert("Welcome!", `${randomGreeting} You're now chatting as ${username}`, "success");
        }

        // ==================== COOLDOWN SYSTEM ====================
        
        async function sendMessage() {
            if (messageCooldown) return;
            
            const text = messageInput.value.trim();
            if (!text) return;
            
            messageCooldown = true;
            startCooldownTimer(sendBtn, 1);
            
            const msg = { username, message: text };
            renderMessage(msg);
            localEchoQueue.push({ username, text });
            messageInput.value = '';
            
            try {
                await supabase.from('themessages').insert([msg]);
            } catch (error) {
                console.error("Error sending message:", error);
            }
            
            setTimeout(() => {
                messageCooldown = false;
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send';
            }, 1000);
        }

        async function sendPrivateMessage() {
            if (privateMessageCooldown) return;
            
            const text = privateMessageInput.value.trim();
            if (!text || !currentPrivateChatWith) return;
            
            privateMessageCooldown = true;
            startCooldownTimer(sendPrivateBtn, 1);
            
            const timestamp = new Date().toISOString();
            const messageId = Date.now();
            
            addPrivateMessageToChat(username, text, timestamp, true);
            
            const chatKey = [username, currentPrivateChatWith].sort().join('_');
            if (!privateChatHistory[chatKey]) {
                privateChatHistory[chatKey] = [];
            }
            privateChatHistory[chatKey].push({
                from: username,
                message: text,
                timestamp,
                isSent: true,
                messageId
            });
            
            savePrivateMessages();
            
            if (callChannel) {
                callChannel.send({
                    type: 'broadcast',
                    event: 'private-message',
                    payload: {
                        from: username,
                        to: currentPrivateChatWith,
                        message: text,
                        timestamp,
                        messageId
                    }
                });
            }
            
            privateMessageInput.value = '';
            
            setTimeout(() => {
                privateMessageCooldown = false;
                sendPrivateBtn.disabled = false;
                sendPrivateBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send';
            }, 1000);
        }

        function startCooldownTimer(button, seconds) {
            button.disabled = true;
            let timeLeft = seconds;
            
            const updateButtonText = () => {
                button.innerHTML = `<i class="fas fa-clock"></i> ${timeLeft}s`;
                timeLeft--;
                
                if (timeLeft < 0) {
                    clearInterval(timer);
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-paper-plane"></i> Send';
                }
            };
            
            updateButtonText();
            const timer = setInterval(updateButtonText, 1000);
            
            if (button === sendBtn) {
                if (messageCooldownTimer) clearInterval(messageCooldownTimer);
                messageCooldownTimer = timer;
            } else if (button === sendPrivateBtn) {
                if (privateMessageCooldownTimer) clearInterval(privateMessageCooldownTimer);
                privateMessageCooldownTimer = timer;
            }
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (e.key === ']' && natureSite.style.display !== 'none') {
                    e.preventDefault();
                    passwordModal.style.display = 'flex';
                    passwordInput.focus();
                }
                
                if (e.key === 'J' && e.shiftKey) {
                    e.preventDefault();
                    if (natureSite.style.display !== 'none') {
                        if (isPasswordUnlocked) {
                            natureSite.style.display = 'none';
                            loginScreen.style.display = 'flex';
                        }
                    } else if (mainApp.style.display !== 'none') {
                        mainApp.style.display = 'none';
                        natureSite.style.display = 'flex';
                    } else if (loginScreen.style.display !== 'none') {
                        loginScreen.style.display = 'none';
                        natureSite.style.display = 'flex';
                    }
                }
                
                if (e.key === 'Escape' && passwordModal.style.display === 'flex') {
                    passwordModal.style.display = 'none';
                }
                
                if (e.key === 'Escape' && privateChatModal.style.display === 'flex') {
                    privateChatModal.style.display = 'none';
                }
                
                if (e.key === 'Enter' && privateChatModal.style.display === 'flex' && 
                    document.activeElement === privateMessageInput) {
                    sendPrivateMessage();
                }
            });
        }

        // ==================== EVENT LISTENERS ====================
        
        loginBtn.addEventListener('click', async function() {
            const name = usernameInput.value.trim();
            if (!name) {
                showAlert("Hold up!", "You gotta enter a username first!", "error");
                return;
            }
            
            if (name.length < 2) {
                showAlert("Too short!", "Username needs at least 2 characters", "error");
                return;
            }
            
            if (name.length > 20) {
                showAlert("Too long!", "Keep it under 20 characters", "error");
                return;
            }
            
            await performLogin(name);
        });

        usernameInput.addEventListener('input', async function() {
            const name = this.value.trim();
            if (name.length >= 2) {
                const isAvailable = await isUsernameAvailable(name);
                if (isAvailable) {
                    usernameStatus.innerHTML = `<span class="success">‚úì Available</span>`;
                } else {
                    usernameStatus.innerHTML = `<span class="error">‚úó Taken</span>`;
                }
            } else {
                usernameStatus.innerHTML = `<span class="info">Minimum 2 characters</span>`;
            }
        });

        passwordSubmit.addEventListener('click', function() {
            const password = passwordInput.value.trim();
            if (password === 'BRUHISKING') {
                isPasswordUnlocked = true;
                localStorage.setItem('passwordUnlocked', 'true');
                passwordModal.style.display = 'none';
                passwordInput.value = '';
                
                natureSite.style.display = 'none';
                loginScreen.style.display = 'flex';
                
                showAlert("Access Granted", "Welcome to the collaborative learning platform!", "success");
            } else {
                showAlert("Access Denied", "Incorrect password. Try again.", "error");
                passwordInput.value = '';
                passwordInput.focus();
            }
        });

        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                passwordSubmit.click();
            }
        });

        function setupEventListeners() {
            sendBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', e => {
                if (e.key === 'Enter') sendMessage();
            });

            let typingTimeout;
            messageInput.addEventListener('input', function() {
                if (callChannel && username) {
                    callChannel.send({
                        type: 'broadcast',
                        event: 'user-typing',
                        payload: { username, isTyping: true }
                    });
                    
                    if (typingTimeout) clearTimeout(typingTimeout);
                    
                    typingTimeout = setTimeout(() => {
                        if (callChannel) {
                            callChannel.send({
                                type: 'broadcast',
                                event: 'user-typing',
                                payload: { username, isTyping: false }
                            });
                        }
                    }, 2000);
                }
            });

            searchMessages.addEventListener('input', filterMessages);

            refreshBtn.addEventListener('click', function() {
                loadMessages();
                showAlert("Refreshed!", "Messages updated successfully", "success");
            });

            callMuteBtn.addEventListener('click', toggleMute);
            callFullscreenBtn.addEventListener('click', toggleFullscreen);
            callShareBtn.addEventListener('click', toggleShareScreen);
            callHangupBtn.addEventListener('click', endVideoCall);

            document.getElementById('account-btn').addEventListener('click', function() {
                showUserInfo(username);
            });

            sendPrivateBtn.addEventListener('click', sendPrivateMessage);
            privateMessageInput.addEventListener('keypress', e => {
                if (e.key === 'Enter') sendPrivateMessage();
            });
            closePrivateChat.addEventListener('click', () => {
                privateChatModal.style.display = 'none';
                currentPrivateChatWith = null;
            });

            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'visible') {
                    updateOnlineStatus();
                } else {
                    if (username) {
                        const now = Date.now();
                        chatUsers.set(username, { 
                            lastSeen: new Date().toISOString(), 
                            online: false,
                            lastUpdated: now
                        });
                        updateUserList();
                    }
                }
            });

            document.addEventListener('mousemove', function() {
                if (username) {
                    updateOnlineStatus();
                }
            });

            window.addEventListener('beforeunload', function() {
                cleanupAllResources();
            });
        }

        function cleanupAllResources() {
            endVideoCall();
            
            if (onlineCheckInterval) {
                clearInterval(onlineCheckInterval);
                onlineCheckInterval = null;
            }
            
            if (username && callChannel) {
                callChannel.send({
                    type: 'broadcast',
                    event: 'online-status',
                    payload: { 
                        username, 
                        status: 'offline',
                        lastSeen: new Date().toISOString(),
                        timestamp: Date.now()
                    }
                });
            }
        }

        function showUserInfo(user) {
            const modal = document.createElement('div');
            modal.className = 'profile-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            const userData = chatUsers.get(user) || { online: false, lastSeen: null, lastUpdated: 0 };
            const isOnline = userData.online;
            const lastSeenTime = userData.lastUpdated || 0;
            
            modal.innerHTML = `
                <div style="background: rgba(38, 70, 83, 0.95); padding: 30px; border-radius: 12px; width: 400px; border: 1px solid rgba(255, 255, 255, 0.1);">
                    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 25px;">
                        <div style="width: 80px; height: 80px; min-width: 80px; min-height: 80px; border-radius: 50%; background: ${getUserColor(user)}; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; color: white; flex-shrink: 0;">
                            ${user[0].toUpperCase()}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <h3 style="font-size: 1.6rem; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${user}</h3>
                            <div style="display: flex; align-items: center; gap: 8px; color: ${isOnline ? '#4cc9f0' : '#6c757d'}; flex-wrap: wrap;">
                                <span style="width: 8px; height: 8px; border-radius: 50%; background: ${isOnline ? '#4cc9f0' : '#6c757d'}; flex-shrink: 0;"></span>
                                <span style="flex-shrink: 0;">${isOnline ? 'Online ‚Ä¢ Active now' : 'Offline'}</span>
                                ${!isOnline && lastSeenTime > 0 ? `<div style="font-size: 0.8rem; color: var(--gray); flex-shrink: 0;">Last seen: ${formatTimeSince(lastSeenTime)}</div>` : ''}
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px;">
                        ${user !== username && isOnline ? `
                        <button class="btn" style="flex: 1;" id="modalCallBtn">
                            <i class="fas fa-video"></i>
                            Video Call
                        </button>
                        ` : ''}
                        ${user !== username ? `
                        <button class="btn" style="flex: 1; background: var(--secondary);" id="modalPrivateChatBtn">
                            <i class="fas fa-comment-dots"></i>
                            Private Chat
                        </button>
                        ` : ''}
                        <button class="btn btn-outline" style="flex: 1;" id="modalCloseBtn">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            if (user !== username && isOnline) {
                document.getElementById('modalCallBtn').addEventListener('click', function() {
                    modal.remove();
                    initiateCall(user);
                });
            }
            
            if (user !== username) {
                document.getElementById('modalPrivateChatBtn').addEventListener('click', function() {
                    modal.remove();
                    openPrivateChat(user);
                });
            }
            
            document.getElementById('modalCloseBtn').addEventListener('click', function() {
                modal.remove();
            });
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function openPrivateChat(user) {
            currentPrivateChatWith = user;
            privateChatTitle.textContent = `Private Chat with ${user}`;
            privateChatMessages.innerHTML = '';
            
            const chatKey = [username, user].sort().join('_');
            if (privateChatHistory[chatKey]) {
                privateChatHistory[chatKey].forEach(msg => {
                    addPrivateMessageToChat(msg.from, msg.message, msg.timestamp, msg.isSent);
                });
            }
            
            privateChatModal.style.display = 'flex';
            privateMessageInput.focus();
            
            setTimeout(() => {
                privateChatMessages.scrollTop = privateChatMessages.scrollHeight;
            }, 100);
        }

        function addPrivateMessageToChat(sender, message, timestamp, isSent) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + (isSent ? 'sent' : 'received');
            
            const displayTime = formatMessageDate(timestamp || new Date().toISOString());
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            avatarDiv.style.background = getUserColor(sender);
            avatarDiv.textContent = sender[0].toUpperCase();
            
            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'message-content-wrapper';
            
            if (!isSent) {
                const senderName = document.createElement('div');
                senderName.className = 'message-sender';
                senderName.textContent = sender;
                contentWrapper.appendChild(senderName);
            }
            
            const messageHTML = `
                <div class="message-bubble">
                    <div class="message-content">${message}</div>
                    <div class="message-meta">
                        <span class="message-time">${displayTime}</span>
                    </div>
                </div>
            `;
            
            contentWrapper.innerHTML += messageHTML;
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentWrapper);
            
            privateChatMessages.appendChild(messageDiv);
            
            setTimeout(() => {
                privateChatMessages.scrollTop = privateChatMessages.scrollHeight;
            }, 100);
        }

        function loadPrivateMessages() {
            const saved = localStorage.getItem('privateChatHistory');
            if (saved) {
                try {
                    privateChatHistory = JSON.parse(saved);
                } catch (e) {
                    console.error('Error loading private messages:', e);
                    privateChatHistory = {};
                }
            }
        }

        function savePrivateMessages() {
            try {
                localStorage.setItem('privateChatHistory', JSON.stringify(privateChatHistory));
            } catch (e) {
                console.error('Error saving private messages:', e);
            }
        }

        function renderMessage(msg) {
            const messageDiv = document.createElement('div');
            const isSent = username === msg.username;
            messageDiv.className = 'message ' + (isSent ? 'sent' : 'received');
            
            const messageDate = msg.created_at || new Date().toISOString();
            const displayTime = formatMessageDate(messageDate);
            
            if (needsDateSeparator(messageDate)) {
                const separator = createDateSeparator(messageDate);
                chatMessages.appendChild(separator);
            }
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            avatarDiv.style.background = getUserColor(msg.username);
            avatarDiv.textContent = msg.username[0].toUpperCase();
            avatarDiv.title = `View ${msg.username}'s profile`;
            avatarDiv.addEventListener('click', () => {
                showUserInfo(msg.username);
            });
            
            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'message-content-wrapper';
            
            if (!isSent) {
                const senderName = document.createElement('div');
                senderName.className = 'message-sender';
                senderName.textContent = msg.username;
                senderName.title = `View ${msg.username}'s profile`;
                senderName.addEventListener('click', () => {
                    showUserInfo(msg.username);
                });
                contentWrapper.appendChild(senderName);
            }
            
            const messageHTML = `
                <div class="message-bubble">
                    <div class="message-content">${msg.message}</div>
                    <div class="message-meta">
                        <span class="message-time">${displayTime}</span>
                    </div>
                </div>
            `;
            
            contentWrapper.innerHTML += messageHTML;
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentWrapper);
            
            chatMessages.appendChild(messageDiv);
            
            if (!chatUsers.has(msg.username)) {
                const messageTime = new Date(msg.created_at).getTime() || Date.now();
                chatUsers.set(msg.username, { 
                    lastSeen: msg.created_at || new Date().toISOString(), 
                    online: false,
                    lastUpdated: messageTime
                });
                updateUserList();
            } else {
                const userData = chatUsers.get(msg.username);
                const messageTime = new Date(msg.created_at).getTime() || Date.now();
                userData.lastSeen = msg.created_at || new Date().toISOString();
                userData.lastUpdated = Math.max(userData.lastUpdated || 0, messageTime);
            }
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function loadMessages() {
            const { data } = await supabase.from('themessages').select('*').order('id', { ascending: true });
            chatMessages.innerHTML = '';
            lastMessageDate = null;
            
            if (data && data.length > 0) {
                data.forEach(renderMessage);
            } else {
                chatMessages.innerHTML = '<div style="text-align: center; padding: 40px 20px; color: var(--gray);"><i class="fas fa-comments" style="font-size: 2rem; margin-bottom: 10px;"></i><p>No messages yet. Start chatting!</p></div>';
            }
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function filterMessages() {
            const searchTerm = searchMessages.value.toLowerCase();
            const messageElements = document.querySelectorAll('.message');
            const dateSeparators = document.querySelectorAll('.date-separator');
            
            dateSeparators.forEach(separator => {
                separator.style.display = 'none';
            });
            
            let lastVisibleDateSeparator = null;
            
            messageElements.forEach(element => {
                const messageText = element.querySelector('.message-content').textContent.toLowerCase();
                if (messageText.includes(searchTerm)) {
                    element.style.display = 'flex';
                    
                    const prevElement = element.previousElementSibling;
                    if (prevElement && prevElement.classList.contains('date-separator')) {
                        prevElement.style.display = 'block';
                        lastVisibleDateSeparator = prevElement;
                    }
                } else {
                    element.style.display = 'none';
                }
            });
            
            if (!searchTerm) {
                dateSeparators.forEach(separator => {
                    separator.style.display = 'block';
                });
            }
        }

        function updateUserList() {
            usersContainer.innerHTML = '';
            
            let onlineUsers = 0;
            chatUsers.forEach((userData, user) => {
                if (user !== username && userData.online) {
                    onlineUsers++;
                }
            });
            
            const selfOnline = username ? 1 : 0;
            onlineCount.textContent = onlineUsers + selfOnline;
            
            if (chatUsers.size === 0) {
                usersContainer.innerHTML = '<div style="text-align: center; padding: 40px 20px; color: var(--gray);"><i class="fas fa-user-friends" style="font-size: 2rem; margin-bottom: 10px;"></i><p>No users online</p></div>';
                return;
            }
            
            const sortedUsers = Array.from(chatUsers.entries())
                .filter(([user]) => user !== username)
                .sort(([userA, dataA], [userB, dataB]) => {
                    if (dataA.online && !dataB.online) return -1;
                    if (!dataA.online && dataB.online) return 1;
                    return userA.localeCompare(userB);
                });
            
            sortedUsers.forEach(([user, userData]) => {
                createUserElement(user, userData, usersContainer);
            });
        }

        function createUserElement(user, userData, container) {
            const userItem = document.createElement('div');
            userItem.className = 'user-item';
            
            let statusText = '';
            if (userData.online) {
                statusText = 'Online ‚Ä¢ Ready for calls';
            } else if (userData.lastUpdated > 0) {
                const now = Date.now();
                const diff = now - userData.lastUpdated;
                if (diff < 24 * 60 * 60 * 1000) {
                    statusText = `Offline ‚Ä¢ Last seen ${formatTimeSince(userData.lastUpdated)}`;
                } else {
                    statusText = 'Offline';
                }
            } else {
                statusText = 'Offline';
            }
            
            userItem.innerHTML = `
                <div class="user-avatar" style="background: ${getUserColor(user)}">${user.charAt(0)}</div>
                <div class="user-info">
                    <div class="user-name">${user}</div>
                    <div class="user-status">
                        <span class="status-dot ${userData.online ? 'online' : 'offline'}"></span>
                        ${statusText}
                    </div>
                </div>
            `;
            
            userItem.addEventListener('click', function() {
                document.querySelectorAll('.user-item').forEach(function(item) {
                    item.classList.remove('active');
                });
                userItem.classList.add('active');
                showUserInfo(user);
            });
            
            container.appendChild(userItem);
        }

        supabase.channel('messages')
            .on('postgres_changes', {
                event: 'INSERT',
                schema: 'public',
                table: 'themessages'
            }, payload => {
                const m = payload.new;
                const duplicate = localEchoQueue.find(e => e.username === m.username && e.text === m.message);
                if (duplicate) {
                    localEchoQueue.splice(localEchoQueue.indexOf(duplicate), 1);
                    return;
                }
                renderMessage(m);
            })
            .subscribe();

        function initialize() {
            setupKeyboardShortcuts();
            checkAutoLogin();
            loadPrivateMessages();
            
            natureSite.style.overflowY = 'auto';
            natureSite.style.height = '100vh';
        }

        initialize();
    </script>
</body>
</html>
